<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <title>俯卧撑计数器</title>
    <style>
        :root {
            /* 十二花神主题色 */
            --month-1-bg: #fef9f8;       /* 1月梅花 */
            --month-1-cell: rgba(240, 140, 155, 0.15);
            
            --month-2-bg: #fff8f5;       /* 2月杏花 */
            --month-2-cell: rgba(245, 170, 150, 0.15);
            
            --month-3-bg: #fff7f8;       /* 3月桃花 */
            --month-3-cell: rgba(250, 120, 140, 0.18);
            
            --month-4-bg: #fcf9f7;       /* 4月牡丹 */
            --month-4-cell: rgba(220, 100, 150, 0.2);
            
            --month-5-bg: #fff5f3;       /* 5月石榴 */
            --month-5-cell: rgba(230, 80, 80, 0.18);
            
            --month-6-bg: #f5f9f9;       /* 6月荷花 */
            --month-6-cell: rgba(180, 210, 210, 0.2);
            
            --month-7-bg: #f7f7fa;       /* 7月玉簪 */
            --month-7-cell: rgba(200, 200, 230, 0.18);
            
            --month-8-bg: #fefbf5;       /* 8月桂花 */
            --month-8-cell: rgba(240, 210, 130, 0.18);
            
            --month-9-bg: #faf7f0;       /* 9月菊花 */
            --month-9-cell: rgba(230, 200, 100, 0.18);
            
            --month-10-bg: #fef5f7;      /* 10月芙蓉 */
            --month-10-cell: rgba(245, 130, 160, 0.18);
            
            --month-11-bg: #f9f7f8;      /* 11月山茶 */
            --month-11-cell: rgba(220, 90, 110, 0.18);
            
            --month-12-bg: #f5f8f5;      /* 12月水仙 */
            --month-12-cell: rgba(210, 220, 190, 0.18);
            
            /* 基础文本色 */
            --text-primary: #333333;
            --text-secondary: #666666;
            --row-height: 48px; /* 适度增加行高以匹配放大的数字 */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
            cursor: pointer;
            background: var(--current-bg);
            transition: background 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* 计数区域 */
        #count-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 15px;
        }

        #count {
            font-size: clamp(12rem, 40vw, 32rem);
            font-weight: 200;
            color: var(--text-primary);
            line-height: 1;
            text-align: center;
            letter-spacing: -0.03em;
            transition: transform 0.07s cubic-bezier(0.2, 0, 0.2, 1);
        }

        #count.jump {
            transform: scale(1.015);
        }

        /* 日历区域 - 精确控制高度 */
        #calendar {
            width: 100%;
            background-color: var(--current-cell-bg);
            border-radius: 12px 12px 0 0;
            padding: 15px 10px;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.03);
            position: relative;
            overflow: hidden;
            transition: height 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .calendar-month-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1.08);
            font-size: clamp(6.5rem, 30vw, 13rem);
            font-weight: 300;
            color: rgba(0, 0, 0, 0.02);
            text-transform: uppercase;
            letter-spacing: -0.1em;
            z-index: 0;
            pointer-events: none;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            height: 22px; /* 微调星期标题高度以保持比例 */
        }

        .calendar-weekday {
            text-align: center;
            font-size: 0.7rem; /* 适度放大星期文字 */
            color: var(--text-secondary);
            font-weight: 500;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
            position: relative;
            z-index: 1;
        }

        /* 日期单元格 - 固定行高确保一致性 */
        .calendar-day {
            height: var(--row-height); /* 使用固定行高变量 */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            font-size: 1.35rem; /* 显著放大日期数字 */
            color: var(--cell-text-color);
            transition: all 0.15s ease;
            background-color: transparent !important;
        }

        .calendar-day.today {
            box-shadow: 0 0 0 1px var(--current-cell-glow), 
                        0 0 5px 1.5px var(--current-cell-glow);
            font-weight: 600;
            font-size: 1.45rem; /* 今日日期数字稍大以突出显示 */
            color: var(--text-primary) !important;
        }

        .calendar-day.has-data:not(.today) {
            font-weight: 600;
        }

        .calendar-day.other-month,
        .calendar-day:not(.has-data):not(.today) {
            color: transparent;
        }

        @media (hover: hover) {
            .calendar-day:not(.today):hover {
                background-color: var(--current-cell-hover);
            }
        }

        @supports (padding: env(safe-area-inset-top)) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        [data-loading="true"] {
            opacity: 0;
            transform: translateY(5px);
        }
    </style>
</head>
<body id="container" oncontextmenu="return false" ontouchmove="return false">
    <div id="count-container">
        <div id="count" data-loading="true">0</div>
    </div>
    <div id="calendar">
        <div class="calendar-month-bg" id="calendar-month-bg"></div>
        
        <div class="calendar-weekdays">
            <div class="calendar-weekday">日</div>
            <div class="calendar-weekday">一</div>
            <div class="calendar-weekday">二</div>
            <div class="calendar-weekday">三</div>
            <div class="calendar-weekday">四</div>
            <div class="calendar-weekday">五</div>
            <div class="calendar-weekday">六</div>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <script>
        (function() {
            let currentCount = 0;
            let isAnimating = false;
            let isFirstVisit = !localStorage.getItem('pushupVisited');
            let workoutData = JSON.parse(localStorage.getItem('pushupData')) || {};
            let calendarRows = 6; // 默认行数
            
            const elements = {
                container: document.getElementById('container'),
                count: document.getElementById('count'),
                calendar: document.getElementById('calendar'),
                calendarGrid: document.getElementById('calendar-grid'),
                monthBg: document.getElementById('calendar-month-bg'),
                root: document.documentElement
            };

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-11
            const todayDate = today.getDate();
            const todayKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(todayDate).padStart(2, '0')}`;
            
            // 月份数据
            const monthData = [
                { abbr: "Jan", flower: "梅花" },   // 1月
                { abbr: "Feb", flower: "杏花" },   // 2月
                { abbr: "Mar", flower: "桃花" },   // 3月
                { abbr: "Apr", flower: "牡丹" },   // 4月
                { abbr: "May", flower: "石榴" },   // 5月
                { abbr: "Jun", flower: "荷花" },   // 6月
                { abbr: "Jul", flower: "玉簪" },   // 7月
                { abbr: "Aug", flower: "桂花" },   // 8月
                { abbr: "Sep", flower: "菊花" },   // 9月
                { abbr: "Oct", flower: "芙蓉" },   // 10月
                { abbr: "Nov", flower: "山茶" },   // 11月
                { abbr: "Dec", flower: "水仙" }    // 12月
            ];

            // 计算当月日历精确行数（无空行）
            function calculateExactCalendarRows() {
                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const totalDays = new Date(currentYear, currentMonth + 1, 0).getDate();
                const totalCells = firstDay + totalDays;
                return Math.ceil(totalCells / 7);
            }

            // 根据精确行数设置日历总高度
            function setCalendarExactHeight(rows) {
                // 总高度 = 行高×行数 + 标题高度 + 内边距
                const rowHeight = parseInt(getComputedStyle(elements.root).getPropertyValue('--row-height'));
                const totalHeight = (rowHeight * rows) + 48; // 调整总高度计算值以匹配新行高
                elements.calendar.style.height = `${totalHeight}px`;
                calendarRows = rows;
            }

            // 颜色处理
            function adjustColorBrightness(color, factor) {
                const rgbaMatch = color.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
                if (!rgbaMatch) return color;
                
                const r = parseInt(rgbaMatch[1]);
                const g = parseInt(rgbaMatch[2]);
                const b = parseInt(rgbaMatch[3]);
                const a = parseFloat(rgbaMatch[4]);
                
                const newR = Math.min(255, Math.max(0, r * factor));
                const newG = Math.min(255, Math.max(0, g * factor));
                const newB = Math.min(255, Math.max(0, b * factor));
                
                return `rgba(${Math.round(newR)}, ${Math.round(newG)}, ${Math.round(newB)}, ${a})`;
            }

            // 设置当月主题色
            function setMonthTheme() {
                const monthIndex = currentMonth + 1;
                const cellBg = getComputedStyle(elements.root).getPropertyValue(`--month-${monthIndex}-cell`);
                
                elements.root.style.setProperty('--current-bg', `var(--month-${monthIndex}-bg)`);
                elements.root.style.setProperty('--current-cell-bg', cellBg);
                elements.root.style.setProperty('--current-cell-glow', adjustColorBrightness(cellBg, 1.9));
                elements.root.style.setProperty('--cell-text-color', adjustColorBrightness(cellBg, 2.4));
                elements.root.style.setProperty('--current-cell-hover', adjustColorBrightness(cellBg, 1.3));
            }

            // 初始化日历（无空行设计）
            function initCalendar() {
                elements.monthBg.textContent = monthData[currentMonth].abbr;
                
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
                const totalDaysOfMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const prevMonthDays = firstDayOfMonth;
                const totalCellsNeeded = prevMonthDays + totalDaysOfMonth;
                
                // 计算精确行数并设置高度
                const exactRows = calculateExactCalendarRows();
                setCalendarExactHeight(exactRows);
                
                const fragment = document.createDocumentFragment();
                const totalCellsToRender = exactRows * 7; // 确保填满所有行
                
                // 上月剩余天数
                for (let i = 0; i < prevMonthDays; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day other-month';
                    fragment.appendChild(dayEl);
                }
                
                // 当月天数
                for (let day = 1; day <= totalDaysOfMonth; day++) {
                    const dayEl = document.createElement('div');
                    const dayKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    dayEl.className = 'calendar-day';
                    if (day === todayDate) {
                        dayEl.classList.add('today');
                        dayEl.textContent = workoutData[dayKey] !== undefined ? workoutData[dayKey] : 0;
                    }
                    else if (workoutData[dayKey] && workoutData[dayKey] > 0) {
                        dayEl.textContent = workoutData[dayKey];
                        dayEl.classList.add('has-data');
                    }
                    
                    fragment.appendChild(dayEl);
                }
                
                // 填充剩余单元格（确保行数完整但视觉隐藏）
                const remainingCells = totalCellsToRender - totalCellsNeeded;
                for (let i = 0; i < remainingCells; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day other-month';
                    fragment.appendChild(dayEl);
                }
                
                elements.calendarGrid.appendChild(fragment);

                // 首次访问引导
                if (isFirstVisit) {
                    localStorage.setItem('pushupVisited', 'true');
                    
                    setTimeout(() => {
                        const todayCell = elements.calendarGrid.querySelector('.calendar-day.today');
                        if (todayCell) {
                            todayCell.style.transform = 'scale(1.1)';
                            setTimeout(() => {
                                todayCell.style.transform = '';
                            }, 800);
                        }
                    }, 1200);
                }
            }

            // 数据持久化
            function saveTodayData() {
                workoutData[todayKey] = currentCount;
                if ('requestIdleCallback' in window) {
                    requestIdleCallback(() => {
                        localStorage.setItem('pushupData', JSON.stringify(workoutData));
                    });
                } else {
                    setTimeout(() => {
                        localStorage.setItem('pushupData', JSON.stringify(workoutData));
                    }, 500);
                }
                updateTodayCalendarCell();
            }

            // 更新今日单元格
            function updateTodayCalendarCell() {
                const todayCell = elements.calendarGrid.querySelector('.calendar-day.today');
                if (todayCell) {
                    todayCell.textContent = currentCount;
                    todayCell.classList.add('has-data');
                    todayCell.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        todayCell.style.transform = '';
                    }, 100);
                }
            }

            // 点击处理
            function handleClick(e) {
                e.stopPropagation();
                e.preventDefault();
                
                if (isAnimating) return;
                isAnimating = true;

                elements.count.classList.add('jump');
                currentCount++;
                elements.count.textContent = currentCount;

                setTimeout(() => {
                    elements.count.classList.remove('jump');
                    isAnimating = false;
                    saveTodayData();
                }, 70);
            }

            // 初始化
            function init() {
                setMonthTheme();
                currentCount = workoutData[todayKey] !== undefined ? workoutData[todayKey] : 0;
                elements.count.textContent = currentCount;

                elements.count.style.transition = 'opacity 0.6s cubic-bezier(0.25, 0.1, 0.25, 1), transform 0.6s cubic-bezier(0.25, 0.1, 0.25, 1)';
                
                setTimeout(() => {
                    elements.count.removeAttribute('data-loading');
                }, 150);

                initCalendar();
                elements.container.addEventListener('click', handleClick);
                window.addEventListener('beforeunload', () => {
                    localStorage.setItem('pushupData', JSON.stringify(workoutData));
                });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body></html>